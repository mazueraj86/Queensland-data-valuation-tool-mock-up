<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queensland Data Valuation Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .input-group {
            @apply flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center;
        }
        .dot {
            transition: transform 0.3s ease;
        }
        #sameCostsToggle:checked + .block .dot {
            transform: translateX(100%);
        }
        #sameCostsToggle:not(:checked) + .block .dot {
            transform: translateX(0);
        }
        .governance-label-container {
            @apply relative flex justify-center items-center h-8;
        }
        .governance-label {
            @apply absolute px-3 py-1 rounded-full text-xs font-semibold text-white bg-gray-400 opacity-0 transition-opacity duration-300;
        }
        .governance-label.visible {
            @apply opacity-100;
        }
        .tooltip-container {
            @apply relative inline-block;
        }
        .tooltip-text {
            @apply absolute z-10 bottom-full left-1/2 -translate-x-1/2 mb-2 p-2 rounded-lg text-xs text-white bg-gray-800 shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none whitespace-normal;
            max-width: 250px;
        }
        .tooltip-text::after {
            content: '';
            @apply absolute top-full left-1/2 w-0 h-0 border-8 border-transparent border-t-gray-800 -translate-x-1/2;
        }
        .tooltip-container:hover .tooltip-text {
            @apply opacity-100 pointer-events-auto;
        }
        /* New styles for fixed-size governance label */
        .governance-label-box {
            @apply w-24 h-6 flex items-center justify-center text-xs font-bold rounded-md transition-colors duration-300;
        }
        .governance-label-box span {
            @apply px-2 py-1;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Queensland Data Valuation Tool</h1>
            <p class="text-xl text-gray-600">Using the Social Cost-Benefit Analysis Framework to calculate value of data projects</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div class="md:col-span-1 space-y-6">
                <section class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                    <h2 class="text-2xl font-semibold text-blue-800 mb-4">Project Inputs</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="initialInvestment" class="block text-sm font-medium text-gray-700">Initial Investment (AU$)</label>
                            <input type="number" id="initialInvestment" value="100000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                        </div>
                        <div>
                            <label for="discountRate" class="block text-sm font-medium text-gray-700">Discount Rate (%)</label>
                            <input type="number" id="discountRate" value="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="periods" class="block text-sm font-medium text-gray-700">Number of Periods</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="periods" min="1" max="10" value="5" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                            <span id="periodsValue" class="text-lg font-bold text-blue-800">5</span>
                        </div>
                    </div>
                </section>
                
                <section class="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
                    <h2 class="text-2xl font-semibold text-yellow-800 mb-4">Governance Multiplier</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Adjusts the project's value based on data quality and trust.
                    </p>
                    <div class="governance-label-container">
                        <div id="governanceLabel" class="governance-label"></div>
                    </div>
                    <div>
                        <label for="governanceScore" class="sr-only">Governance Score (1-10)</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="governanceScore" min="1" max="10" step="0.1" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                            <span id="governanceScoreValue" class="text-lg font-bold text-yellow-800">5.0</span>
                        </div>
                    </div>
                    <div>
                        <label for="privacyRisk" class="block text-sm font-medium text-gray-700 mt-4">Privacy & Security Risk (%)</label>
                        <p class="text-sm text-gray-600">
                            Estimates the potential monetary loss due to a privacy or security breach.
                        </p>
                        <div class="flex items-center space-x-4 mt-1">
                            <input type="range" id="privacyRisk" min="0" max="100" value="0" class="w-full h-2 bg-red-200 rounded-lg appearance-none cursor-pointer">
                            <span id="privacyRiskValue" class="text-lg font-bold text-red-800">0%</span>
                        </div>
                    </div>
                </section>
                
                <section class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">Calculation Results</h2>
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <p class="text-lg font-medium text-gray-700">Total Net Present Value (NPV)</p>
                            <p id="npvResult" class="text-3xl font-bold text-gray-900 mt-1">$0.00</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <p class="text-lg font-medium text-gray-700">Investment Decision</p>
                            <p id="decisionResult" class="text-xl font-bold text-gray-900 mt-1">
                                Enter values and click 'Calculate'
                            </p>
                        </div>
                    </div>
                </section>
            </div>

            <div class="md:col-span-3 space-y-6">
                <section class="bg-green-50 p-6 rounded-xl border border-green-200">
                    <h2 class="text-2xl font-semibold text-green-800 mb-4 text-center">Annual Costs & Benefits (AU$)</h2>
                    
                    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm flex items-center justify-between">
                        <label for="sameCostsToggle" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="sameCostsToggle" class="sr-only" checked>
                                <div class="block bg-gray-300 w-14 h-8 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform"></div>
                            </div>
                            <span class="ml-3 text-gray-700 font-medium">Are ongoing costs the same for all years?</span>
                        </label>
                    </div>

                    <div id="cost-inputs" class="mb-6">
                        <div id="singleCostInput">
                            <label for="ongoingCosts" class="block text-sm font-medium text-gray-700">Annual Ongoing Costs (AU$)</label>
                            <input type="number" id="ongoingCosts" value="20000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                        </div>
                        <div id="multipleCostsInput" class="hidden mt-4 space-y-4">
                            </div>
                    </div>
                    
                    <div id="annual-cashflows-container">
                        </div>
                    <div class="flex justify-center mt-6">
                        <button id="calculateBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-500 focus:ring-opacity-50">
                            Calculate NPV
                        </button>
                    </div>
                </section>
            </div>
        </main>
        
        <div id="dashboard-container" class="mt-12 hidden">
            <section class="bg-gray-100 p-8 rounded-2xl border-2 border-gray-200">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Project Financial Dashboard</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Cumulative Cash Flow & Annual Benefits</h3>
                    <div class="h-96 w-full">
                        <canvas id="npvChart"></canvas>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const periodsInput = document.getElementById('periods');
            const periodsValueSpan = document.getElementById('periodsValue');
            const annualCashflowsContainer = document.getElementById('annual-cashflows-container');
            const calculateBtn = document.getElementById('calculateBtn');
            const npvResult = document.getElementById('npvResult');
            const decisionResult = document.getElementById('decisionResult');
            const sameCostsToggle = document.getElementById('sameCostsToggle');
            const singleCostInput = document.getElementById('singleCostInput');
            const multipleCostsInput = document.getElementById('multipleCostsInput');
            const dashboardContainer = document.getElementById('dashboard-container');
            const npvChartCanvas = document.getElementById('npvChart');
            
            const governanceScoreInput = document.getElementById('governanceScore');
            const governanceScoreValueSpan = document.getElementById('governanceScoreValue');
            const governanceLabelDiv = document.getElementById('governanceLabel');
            const privacyRiskInput = document.getElementById('privacyRisk');
            const privacyRiskValueSpan = document.getElementById('privacyRiskValue');

            let npvChartInstance;

            const benefitMethods = {
                direct: [
                    { value: 'Historical Data', title: 'Using past financial records to estimate future cost savings.' },
                    { value: 'Market Analysis', title: 'Valuing data based on comparable market pricing or revenue models.' }
                ],
                nonmarket: [
                    { value: 'Contingent Valuation', title: 'A survey-based method to ask people their willingness to pay for a non-market good.' },
                    { value: 'Willingness to Pay', title: 'Directly asking individuals how much they would pay to receive a non-market benefit.' }
                ],
                spillover: [
                    { value: 'Econometric Analysis', title: 'Using statistical methods to model the economic impact of the data asset.' },
                    { value: 'Growth Projections', title: 'Estimating future revenue or job growth based on the data asset’s use.' }
                ]
            };
            
            const getRandomValue = () => Math.floor(Math.random() * 50000) + 1000;

            const getGovernanceLabel = (score) => {
                const labels = {
                    1: { name: 'Poor', color: 'bg-red-500', tooltip: 'Data is scattered and unreliable. No privacy or security measures in place.' },
                    2: { name: 'Fair', color: 'bg-orange-500', tooltip: 'Some organization and basic security. Inconsistent data quality and privacy measures.' },
                    3: { name: 'Good', color: 'bg-yellow-500', tooltip: 'Consistently organized, accessible to authorized users. Data is of good quality.' },
                    4: { name: 'Very Good', color: 'bg-lime-500', tooltip: 'Well-documented, easily integrated, and proactively secured. Data is high quality and de-identified.' },
                    5: { name: 'Excellent', color: 'bg-green-500', tooltip: 'Data is a foundational asset with immutable history, zero-trust security, and automatic quality checks.' }
                };
                const rating = Math.floor(score / 2) + 1;
                return labels[rating] || { name: 'Neutral', color: 'bg-gray-400', tooltip: 'Hover for a rating description.' };
            };

            const updateGovernanceLabel = (score) => {
                const { name, color, tooltip } = getGovernanceLabel(score);
                
                governanceLabelDiv.innerHTML = `
                    <div class="tooltip-container governance-label-box ${color}">
                        <span>${name}</span>
                        <span class="tooltip-text">${tooltip}</span>
                    </div>
                `;
                governanceLabelDiv.classList.add('visible');
            };

            const createBenefitItem = (year, type, desc, value, score, method) => {
                const benefitId = `${type}-${year}-${crypto.randomUUID()}`;
                let valueInput = '';
                if (type === 'direct') {
                    valueInput = `<input type="number" id="${benefitId}" value="${value}" class="flex-none w-32 rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-green-500 focus:border-green-500 transition-colors duration-200">`;
                } else {
                    const calculatedValueId = `${benefitId}-calculated`;
                    valueInput = `
                        <input type="number" value="${score}" min="1" max="10" class="score-input flex-none w-16 rounded-md border-gray-300 shadow-sm p-2 text-sm text-center focus:ring-green-500 focus:border-green-500 transition-colors duration-200" oninput="updateCalculatedValue(this)">
                        <span class="text-gray-500 text-lg">x</span>
                        <input type="number" value="${value}" class="estimated-value-input flex-none w-32 rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-green-500 focus:border-green-500 transition-colors duration-200" oninput="updateCalculatedValue(this)">
                        <span class="text-gray-500 text-sm">=</span>
                        <span id="${calculatedValueId}" class="flex-none w-32 text-right font-medium text-gray-700 p-2">$0.00</span>
                    `;
                }
                
                const methodOptions = benefitMethods[type].map(opt => 
                    `<option value="${opt.value}" title="${opt.title}" ${opt.value === method ? 'selected' : ''}>${opt.value}</option>`
                ).join('');

                return `
                    <div class="input-group">
                        <input type="text" placeholder="Description" value="${desc}" class="flex-1 rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-green-500 focus:border-green-500 transition-colors duration-200">
                        <select class="flex-1 rounded-md border-gray-300 shadow-sm p-2 text-sm focus:ring-green-500 focus:border-green-500 transition-colors duration-200">
                            <option value="">Select a Method</option>
                            ${methodOptions}
                        </select>
                        ${valueInput}
                    </div>
                `;
            };

            const generateCostInputs = (numPeriods) => {
                multipleCostsInput.innerHTML = '';
                for (let i = 1; i <= numPeriods; i++) {
                    const costRow = document.createElement('div');
                    costRow.className = 'flex items-center space-x-2';
                    costRow.innerHTML = `
                        <label for="ongoingCost-${i}" class="text-sm font-medium text-gray-700 flex-1">Year ${i} Ongoing Costs (AU$)</label>
                        <input type="number" id="ongoingCost-${i}" value="20000" class="flex-none w-48 rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                    `;
                    multipleCostsInput.appendChild(costRow);
                }
            };

            window.updateCalculatedValue = (inputElement) => {
                const parentDiv = inputElement.closest('.input-group');
                const scoreInput = parentDiv.querySelector('.score-input');
                const estimatedValueInput = parentDiv.querySelector('.estimated-value-input');
                const calculatedValueSpan = parentDiv.querySelector('span[id$="-calculated"]');

                if (scoreInput && estimatedValueInput && calculatedValueSpan) {
                    const score = parseFloat(scoreInput.value) || 0;
                    const estimatedValue = parseFloat(estimatedValueInput.value) || 0;
                    const calculatedValue = (score / 10) * estimatedValue;
                    calculatedValueSpan.textContent = `$${calculatedValue.toFixed(2)}`;
                }
            };

            const generateAnnualCashFlows = (numPeriods) => {
                annualCashflowsContainer.innerHTML = '';
                for (let i = 1; i <= numPeriods; i++) {
                    const yearSection = document.createElement('div');
                    yearSection.className = 'bg-white p-6 rounded-xl shadow-md mb-6';
                    yearSection.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-4">Year ${i}</h3>`;
                    
                    const sections = [
                        { id: 'direct', title: 'Direct Benefits' },
                        { id: 'nonmarket', title: 'Non-Market Benefits' },
                        { id: 'spillover', title: 'Spillover Benefits' }
                    ];

                    sections.forEach(section => {
                        const benefitContainer = document.createElement('div');
                        benefitContainer.id = `${section.id}-${i}-container`;
                        benefitContainer.className = 'space-y-2 mb-4';

                        const initialData = {
                            direct: { desc: 'Cost savings from efficiency', value: getRandomValue(), method: 'Historical Data' },
                            nonmarket: { desc: 'Willingness to pay for transparency', value: getRandomValue(), score: 8, method: 'Contingent Valuation' },
                            spillover: { desc: 'Value from job creation', value: getRandomValue(), score: 6, method: 'Econometric Analysis' }
                        };

                        const currentData = initialData[section.id];
                        
                        const initialContent = createBenefitItem(i, section.id, currentData.desc, currentData.value, currentData.score, currentData.method);
                        
                        benefitContainer.innerHTML = `
                            <p class="font-semibold text-gray-700">${section.title}</p>
                            ${initialContent}
                        `;
                        yearSection.appendChild(benefitContainer);

                        const addButton = document.createElement('button');
                        addButton.textContent = `+ Add a ${section.id} benefit`;
                        addButton.className = 'bg-gray-200 text-gray-700 text-sm py-1 px-3 rounded-full hover:bg-gray-300 transition-colors duration-200';
                        addButton.onclick = () => {
                            const newBenefit = document.createElement('div');
                            newBenefit.className = 'input-group mt-2';
                            const newRandData = {
                                direct: { desc: '', value: getRandomValue(), method: '' },
                                nonmarket: { desc: '', value: '', score: 5, method: '' },
                                spillover: { desc: '', value: '', score: 5, method: '' }
                            };
                            const newData = newRandData[section.id];
                            newBenefit.innerHTML = createBenefitItem(i, section.id, newData.desc, newData.value, newData.score, newData.method);
                            benefitContainer.appendChild(newBenefit);
                            updateCalculatedValue(newBenefit.querySelector('input'));
                        };
                        yearSection.appendChild(addButton);
                    });
                    annualCashflowsContainer.appendChild(yearSection);
                }
            };

            periodsInput.addEventListener('input', (event) => {
                const numPeriods = parseInt(event.target.value);
                periodsValueSpan.textContent = numPeriods;
                generateAnnualCashFlows(numPeriods);
                generateCostInputs(numPeriods);
                updateAllCalculatedValues();
            });

            sameCostsToggle.addEventListener('change', () => {
                if (sameCostsToggle.checked) {
                    singleCostInput.classList.remove('hidden');
                    multipleCostsInput.classList.add('hidden');
                } else {
                    singleCostInput.classList.add('hidden');
                    multipleCostsInput.classList.remove('hidden');
                }
            });

            governanceScoreInput.addEventListener('input', (event) => {
                const score = parseFloat(event.target.value);
                governanceScoreValueSpan.textContent = score.toFixed(1);
                updateGovernanceLabel(score);
            });

            privacyRiskInput.addEventListener('input', (event) => {
                privacyRiskValueSpan.textContent = `${parseFloat(event.target.value)}%`;
            });

            const updateAllCalculatedValues = () => {
                document.querySelectorAll('.input-group .score-input').forEach(input => {
                    updateCalculatedValue(input);
                });
            };
            
            const updateDashboard = (data) => {
                dashboardContainer.classList.remove('hidden');
                
                if (npvChartInstance) {
                    npvChartInstance.destroy();
                }

                const chartLabels = data.labels.slice(1);
                const benefitData = data.benefitData;

                npvChartInstance = new Chart(npvChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                type: 'bar',
                                label: 'Direct Benefits',
                                data: [0, ...benefitData.direct],
                                backgroundColor: 'rgb(16, 185, 129, 0.6)',
                                stack: 'benefits',
                                order: 1
                            },
                            {
                                type: 'bar',
                                label: 'Non-Market Benefits',
                                data: [0, ...benefitData.nonmarket],
                                backgroundColor: 'rgb(99, 102, 241, 0.6)',
                                stack: 'benefits',
                                order: 1
                            },
                            {
                                type: 'bar',
                                label: 'Spillover Benefits',
                                data: [0, ...benefitData.spillover],
                                backgroundColor: 'rgb(139, 92, 246, 0.6)',
                                stack: 'benefits',
                                order: 1
                            },
                            {
                                type: 'line',
                                label: 'Cumulative Cash Flow',
                                data: data.values,
                                borderColor: 'rgb(52, 211, 153)',
                                borderWidth: 5,
                                fill: false,
                                tension: 0.3,
                                yAxisID: 'y1',
                                pointStyle: 'circle',
                                pointRadius: 8,
                                pointHoverRadius: 10,
                                order: 2,
                                segment: {
                                    borderColor: ctx => {
                                        const p0 = ctx.p0.parsed.y;
                                        const p1 = ctx.p1.parsed.y;
                                        if (p1 < 0) return 'rgb(239, 68, 68)';
                                        if (p0 < 0 && p1 >= 0) return 'rgb(251, 191, 36)';
                                        return 'rgb(52, 211, 153)';
                                    },
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label === 'Year 0' ? 'Initial Investment' : `Year ${context[0].label.replace('Year ', '')}`;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (context.dataset.type === 'line') {
                                            label = 'Cumulative Cash Flow';
                                        }
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += `AU$${context.parsed.y.toFixed(2)}`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Years'
                                },
                                grid: {
                                    display: false
                                },
                                stacked: true,
                                barPercentage: 0.8,
                                categoryPercentage: 0.5,
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Annual Benefit Value (AU$)'
                                },
                                beginAtZero: true,
                                stacked: true,
                                ticks: {
                                    callback: function(value) {
                                        return `AU$${value.toLocaleString()}`;
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Cumulative Cash Flow (AU$)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: function(value) {
                                        return `AU$${value.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            calculateBtn.addEventListener('click', () => {
                const initialInvestment = parseFloat(document.getElementById('initialInvestment').value) || 0;
                const discountRate = parseFloat(document.getElementById('discountRate').value) / 100 || 0;
                const years = parseInt(periodsInput.value);
                const governanceScore = parseFloat(governanceScoreInput.value);
                const privacyRisk = parseFloat(privacyRiskInput.value) / 100;
                
                let totalNPV = -initialInvestment;
                
                const labels = ['Year 0'];
                const cumulativeValues = [-initialInvestment];
                const benefitData = {
                    direct: [],
                    nonmarket: [],
                    spillover: []
                };

                for (let i = 1; i <= years; i++) {
                    let ongoingCosts;
                    if (sameCostsToggle.checked) {
                        ongoingCosts = parseFloat(document.getElementById('ongoingCosts').value) || 0;
                    } else {
                        ongoingCosts = parseFloat(document.getElementById(`ongoingCost-${i}`).value) || 0;
                    }
                    
                    let totalYearBenefits = 0;
                    let directBenefits = 0;
                    let nonmarketBenefits = 0;
                    let spilloverBenefits = 0;

                    const directGroups = document.querySelectorAll(`#direct-${i}-container .input-group`);
                    directGroups.forEach(group => {
                        const value = parseFloat(group.querySelector('input[type="number"]').value) || 0;
                        directBenefits += value;
                        totalYearBenefits += value;
                    });
                    
                    const nonmarketGroups = document.querySelectorAll(`#nonmarket-${i}-container .input-group`);
                    nonmarketGroups.forEach(group => {
                        const score = parseFloat(group.querySelector('.score-input').value) || 0;
                        const estimatedValue = parseFloat(group.querySelector('.estimated-value-input').value) || 0;
                        const calculatedValue = (score / 10) * estimatedValue;
                        nonmarketBenefits += calculatedValue;
                        totalYearBenefits += calculatedValue;
                    });
                    
                    const spilloverGroups = document.querySelectorAll(`#spillover-${i}-container .input-group`);
                    spilloverGroups.forEach(group => {
                        const score = parseFloat(group.querySelector('.score-input').value) || 0;
                        const estimatedValue = parseFloat(group.querySelector('.estimated-value-input').value) || 0;
                        const calculatedValue = (score / 10) * estimatedValue;
                        spilloverBenefits += calculatedValue;
                        totalYearBenefits += calculatedValue;
                    });

                    benefitData.direct.push(directBenefits);
                    benefitData.nonmarket.push(nonmarketBenefits);
                    benefitData.spillover.push(spilloverBenefits);

                    const netCashFlow = totalYearBenefits - ongoingCosts;
                    const presentValue = netCashFlow / Math.pow(1 + discountRate, i);
                    totalNPV += presentValue;
                    
                    labels.push(`Year ${i}`);
                    cumulativeValues.push(cumulativeValues[cumulativeValues.length - 1] + netCashFlow);
                }
                
                const governanceMultiplier = governanceScore / 5.0; 
                const adjustedNPV = totalNPV * governanceMultiplier * (1 - privacyRisk);

                npvResult.textContent = `$${adjustedNPV.toFixed(2)}`;
                
                if (adjustedNPV > 0) {
                    decisionResult.textContent = 'Accept Project';
                    decisionResult.classList.remove('text-red-600', 'text-yellow-600');
                    decisionResult.classList.add('text-green-600');
                } else if (adjustedNPV < 0) {
                    decisionResult.textContent = 'Reject Project';
                    decisionResult.classList.remove('text-green-600', 'text-yellow-600');
                    decisionResult.classList.add('text-red-600');
                } else {
                    decisionResult.textContent = 'Indifferent';
                    decisionResult.classList.remove('text-green-600', 'text-red-600');
                    decisionResult.classList.add('text-yellow-600');
                }

                updateDashboard({
                    labels: labels,
                    values: cumulativeValues,
                    benefitData: benefitData
                });
            });

            // Event listener for the new minimalist governance slider
            governanceScoreInput.addEventListener('input', (event) => {
                const score = parseFloat(event.target.value);
                governanceScoreValueSpan.textContent = score.toFixed(1);
                
                const { name, color, tooltip } = getGovernanceLabel(score);

                governanceLabelDiv.innerHTML = `
                    <div class="tooltip-container governance-label-box ${color}">
                        <span>${name}</span>
                        <span class="tooltip-text">${tooltip}</span>
                    </div>
                `;
            });
            
            // Initial setup on page load
            generateAnnualCashFlows(parseInt(periodsInput.value));
            generateCostInputs(parseInt(periodsInput.value));
            updateAllCalculatedValues();
            updateGovernanceLabel(parseFloat(governanceScoreInput.value));

        });
    </script>
</body>
</html>
